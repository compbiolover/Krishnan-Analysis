---
title: "MECP2 Analysis"
author: "Andrew Willems and Tian Hong"
date: "5/23/2022"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
```

## Objective
We are doing  analysis on the new set of cohorts from the Krishnan lab for MECP2. First, we use intraclass correlation coefficient (ICC) values of the Cohort, Cell type, Cell number, and Image variables to determine if we need to build linear mixed effects models. After investigating if we need LMEs we then create heat maps of the MECP2 data. We compare the differences in means between the various conditions.

## Step One
Load needed packages. `effectsize` is used to calculate the effect sizes of the differences in our various conditions/treatments. `ggforce` is used to make the sina plots. `ggpubr` is for the grouped plot support. `ggsignif` is used to add statistical results to ggplot plots. `gt` is used for making the nice tables. `ICC` is used to calculate the intraclass correlation coefficient to tell us if we can treat our predictors (variables) as independent or not. `magrittr` is a package that allows us to use pipes (%>%) in our code.`modelsummary` allows us to make our linear mixed effects (lme) model output more professional looking. `nlme` is the package that performs the linear mixed effects (lme) model fits. `rstatix` is used to do the pairwise t-tests and p-value correction. `tidyverse` is used for data manipulation. `webshot` is used to save our gt tables as .png files.

```{r message=FALSE, echo=FALSE, eval=TRUE}
#Loading needed packages
library(effectsize)
library(ggforce)
library(ggpubr)
library(ggsignif)
library(gt)
library(ICC)
library(magrittr)
library(modelsummary)
library(nlme)
library(rstatix)
library(tidyverse)
library(webshot)
```

## Step Two
Load the data and make separate data frames that are comprised of only 6 or 12 week data. The warning here is okay. When I make all columns numeric it introduces some NAs because not all columns have the same number of rows (some just have no data in that row and therefore they get an NA). I fill those NAs in with a 0. 
```{r loading-data, tidy=TRUE, tidy.opts=list(arrow=TRUE, indent=2), echo=FALSE, results='hide', warning=TRUE, eval=FALSE}
#Loading the data
mecp2_data <- read.csv("~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Data/mecp2_raw_histogram_data_excluded_values_removed.csv")

mecp2_metadata_6wk <- mecp2_data[1:6,1:378]
mecp2_metadata_12wk <- mecp2_data[1:6,379:811]
mecp2_intensity <- mecp2_data[7:2164,2:811]
mecp2_intensity_6wk <- mecp2_intensity[,1:377]
mecp2_intensity_12wk <- mecp2_intensity[,378:810]

mecp2_intensity_6wk <- apply(mecp2_intensity_6wk, 2, as.numeric)
mecp2_intensity_12wk <- apply(mecp2_intensity_12wk, 2, as.numeric)

#mecp2_intensity_6wk[is.na(mecp2_intensity_6wk)] <- 0
#mecp2_intensity_12wk[is.na(mecp2_intensity_12wk)] <- 0

mecp2_data_processed_6wk <- data.frame(Cell_type=as.character(mecp2_metadata_6wk[1,]),
                                   Cohort=as.character(mecp2_metadata_6wk[2,]),
                                   Condition=as.character(mecp2_metadata_6wk[3,]),
                                   Hemisphere=as.character(mecp2_metadata_6wk[4,]),
                                   Image=as.character(mecp2_metadata_6wk[5,]),
                                   Cell_number=as.character(mecp2_metadata_6wk[6,]))

mecp2_data_processed_6wk <- mecp2_data_processed_6wk[2:378,]
mecp2_data_processed_6wk <- na.omit(mecp2_data_processed_6wk)
rownames(mecp2_data_processed_6wk) <- seq(1:nrow(mecp2_data_processed_6wk))

mecp2_data_processed_12wk <- data.frame(Cell_type=as.character(mecp2_metadata_12wk[1,]),
                                   Cohort=as.character(mecp2_metadata_12wk[2,]),
                                   Condition=as.character(mecp2_metadata_12wk[3,]),
                                   Hemisphere=as.character(mecp2_metadata_12wk[4,]),
                                   Image=as.character(mecp2_metadata_12wk[5,]),
                                   Cell_number=as.character(mecp2_metadata_12wk[6,]))


mecp2_data_processed_12wk <- mecp2_data_processed_12wk[1:433,]
mecp2_data_processed_12wk <- na.omit(mecp2_data_processed_12wk)
rownames(mecp2_data_processed_12wk) <- seq(1:nrow(mecp2_data_processed_12wk))


# mecp2_data_processed_6wk <- mecp2_data_processed_6wk[2:817,]
# mecp2_data_processed_12wk <- mecp2_data_processed_12wk[2:817,]

head(mecp2_data_processed_6wk)
head(mecp2_data_processed_12wk)

dim(mecp2_data_processed_6wk)
dim(mecp2_data_processed_12wk)
```


## Step Three: Getting straight mean for all of our data
Six week old data
```{r 6-week-straight-mean, message=FALSE, fig.show='hide', echo=FALSE, warning=FALSE, eval=FALSE, include=FALSE}
#Doing density estimates for each of the columns of our data frame to get 
#means for further analysis for 6wk data
mean_6wk <- apply(mecp2_intensity_6wk, 2, mean, na.rm=TRUE)
```

Twelve week old data
```{r 12-week-straight-mean, message=FALSE, fig.show='hide', echo=FALSE, warning=FALSE, eval=FALSE, include=FALSE}
#Doing density estimates for each of the columns of our data frame to get 
#means for further analysis for 12wk data
mean_12wk <- apply(mecp2_intensity_12wk, 2, mean, na.rm=TRUE)
```


```{r 6-week-gmm-plots-being-saved, echo=FALSE, message=FALSE, eval=FALSE, include=FALSE}
#Plotting the results and saving the mean to do more analysis later
setwd("~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Figures/Mecp2_figures")
first_means_6wk <- rep(0, 816)
second_means_6wk <- rep(0, 816)
all_plots <- list()
counter <- 1
for(gm in gmm_mod_6wk){
  current_mod <- gm
  first_means_6wk[counter] <- current_mod$parameters$mean[1]
  
  current_mod_ggplot <- as.data.frame(current_mod$density)
  colnames(current_mod_ggplot) <- "density"
  current_mod_ggplot$mean <- first_means_6wk[counter]
  density_plot <- ggplot(data = current_mod_ggplot, aes(x=density)) +
    geom_density(color="blue",
                 fill= "#87ceeb",
                 alpha=0.8) +
    theme(panel.background = element_blank())+
    xlab("Intensity")+ ylab("Density")
  len <- length(all_plots)
  all_plots[[len+1]] <- density_plot
  
  ggsave(filename = paste0("density_plot_mecp2_6wk_", len, ".png"), device = "png",
         dpi = 300, height = 12, width = 12, unit= "cm", plot = density_plot)
  counter <- counter + 1
}

```




```{r 12-week-gmm-plots-being-saved, echo=FALSE, message=FALSE, eval=FALSE, include=FALSE}
#Plotting the results and saving the mean to do more analysis later
setwd("~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Figures/Mecp2_figures")
first_means_12wk <- rep(0, 816)
second_means_12wk <- rep(0, 816)
all_plots <- list()
counter <- 1
for(gm in gmm_mod_12wk){
  current_mod <- gm
  first_means_12wk[counter] <- current_mod$parameters$mean[1]
  
  current_mod_ggplot <- as.data.frame(current_mod$density)
  colnames(current_mod_ggplot) <- "density"
  current_mod_ggplot$mean <- first_means_12wk[counter]
  density_plot <- ggplot(data = current_mod_ggplot, aes(x=density)) +
    geom_density(color="blue",
                 fill= "#87ceeb",
                 alpha=0.8) +
    theme(panel.background = element_blank())+
    xlab("Intensity")+ ylab("Density")
  len <- length(all_plots)
  all_plots[[len+1]] <- density_plot
  
  ggsave(filename = paste0("density_plot_mecp2_12wk_", len, ".png"), device = "png",
         dpi = 300, height = 12, width = 12, unit= "cm", plot = density_plot)
  counter <- counter + 1
}
```


## Step Five: Adding the means to our overall data frames
```{r adding-straight-means-to-dataframe, echo=FALSE, eval=FALSE}
mecp2_data_processed_6wk$Mean <- mean_6wk

mecp2_data_processed_6wk$Time <- rep("6 wk",
                                     times=nrow(mecp2_data_processed_6wk))
gt(head(mecp2_data_processed_6wk))



mecp2_data_processed_12wk$Mean <- mean_12wk
mecp2_data_processed_12wk$Time <- rep("12 wk",
                                      times=nrow(mecp2_data_processed_12wk))
gt(head(mecp2_data_processed_12wk))
```

Filtering to just naive `Condition`
```{r}
mecp2_data_processed_6wk <- mecp2_data_processed_6wk %>% filter(Condition=="NW" | Condition=="NH")
mecp2_data_processed_12wk <- mecp2_data_processed_12wk %>% filter(Condition=="NW" | Condition=="NH")
```

Relabeling `NW` and `NH` as `WT` and `Het` respectively
```{r}
mecp2_data_processed_6wk$Condition <- gsub(x = mecp2_data_processed_6wk$Condition, pattern = "NW", replacement = "WT")
mecp2_data_processed_6wk$Condition <- gsub(x = mecp2_data_processed_6wk$Condition, pattern = "NH", replacement = "Het")

mecp2_data_processed_12wk$Condition <- gsub(x = mecp2_data_processed_12wk$Condition, pattern = "NW", replacement = "WT")
mecp2_data_processed_12wk$Condition <- gsub(x = mecp2_data_processed_12wk$Condition, pattern = "NH", replacement = "Het")
```


Checking to see if my mean for Condition is the same as Logan's
```{r}
by_cohort_age_type <- mecp2_data_processed_6wk %>% group_by(Cohort, Time, Cell_type, Condition, Hemisphere)
by_cohort_age_type
```
```{r}
by_cohort_age_type <- by_cohort_age_type %>% summarise(Intensity= mean(Mean))

by_cohort_age_type
```



```{r adding-gmm-means-to-dataframe, echo=FALSE, eval=FALSE, include=FALSE}
#Now appending the mean to the other metadata for this MECP2 data set for the
#6 week and 12 week data frames
mecp2_data_processed_6wk$Mean <- first_means_6wk

mecp2_data_processed_6wk$Time <- rep("6 wk",
                                     times=nrow(mecp2_data_processed_6wk))
gt(head(mecp2_data_processed_6wk))



mecp2_data_processed_12wk$Mean <- first_means_12wk
mecp2_data_processed_12wk$Time <- rep("12 wk",
                                      times=nrow(mecp2_data_processed_12wk))
gt(head(mecp2_data_processed_12wk))
```

Now sub-setting our data frame to just naive samples (NH and NW) and then relabeling them as Het or WT to follow pre-print convention. Finally, we factor them in the same order seen in the plot in the pre-print
```{r 6-week-relabeling-conditions, echo=FALSE, eval=FALSE}
mecp2_data_processed_6wk_simp <- mecp2_data_processed_6wk
mecp2_data_processed_6wk_simp <- filter(mecp2_data_processed_6wk_simp,
                                        Condition=="NH" | Condition=="NW")

mecp2_data_processed_6wk_simp_pos <- filter(mecp2_data_processed_6wk_simp, Cell_type=="PNN-pos")
mecp2_data_processed_6wk_simp_neg <- filter(mecp2_data_processed_6wk_simp, Cell_type=="PNN-neg")

mecp2_data_processed_6wk_simp_neg$Condition <- gsub(x = mecp2_data_processed_6wk_simp_neg$Condition, pattern = "NH", replacement = "Het")
mecp2_data_processed_6wk_simp_neg$Condition <- gsub(x = mecp2_data_processed_6wk_simp_neg$Condition, pattern = "NW", replacement = "WT")
mecp2_data_processed_6wk_simp_pos$Condition <- gsub(x = mecp2_data_processed_6wk_simp_pos$Condition, pattern = "NH", replacement = "Het")
mecp2_data_processed_6wk_simp_pos$Condition <- gsub(x = mecp2_data_processed_6wk_simp_pos$Condition, pattern = "NW", replacement = "WT")


mecp2_data_processed_6wk_simp_neg$Condition <- factor(mecp2_data_processed_6wk_simp_neg$Condition, levels = c("WT", "Het"))
mecp2_data_processed_6wk_simp_pos$Condition <- factor(mecp2_data_processed_6wk_simp_pos$Condition, levels = c("WT", "Het"))
```

Doing the same for 12 week old data
```{r 12-week-relabeling-conditions, echo=FALSE, eval=FALSE}
mecp2_data_processed_12wk_simp <- mecp2_data_processed_12wk

mecp2_data_processed_12wk_simp <- filter(mecp2_data_processed_12wk_simp,
                                        Condition=="NH" | Condition=="NW")

mecp2_data_processed_12wk_simp_pos <- filter(mecp2_data_processed_12wk_simp, Cell_type=="PNN-pos")
mecp2_data_processed_12wk_simp_neg <- filter(mecp2_data_processed_12wk_simp, Cell_type=="PNN-neg")

mecp2_data_processed_12wk_simp_neg$Condition <- gsub(x = mecp2_data_processed_12wk_simp_neg$Condition, pattern = "NH", replacement = "Het")
mecp2_data_processed_12wk_simp_neg$Condition <- gsub(x = mecp2_data_processed_12wk_simp_neg$Condition, pattern = "NW", replacement = "WT")
mecp2_data_processed_12wk_simp_pos$Condition <- gsub(x = mecp2_data_processed_12wk_simp_pos$Condition, pattern = "NH", replacement = "Het")
mecp2_data_processed_12wk_simp_pos$Condition <- gsub(x = mecp2_data_processed_12wk_simp_pos$Condition, pattern = "NW", replacement = "WT")


mecp2_data_processed_12wk_simp_neg$Condition <- factor(mecp2_data_processed_12wk_simp_neg$Condition, levels = c("WT", "Het"))
mecp2_data_processed_12wk_simp_pos$Condition <- factor(mecp2_data_processed_12wk_simp_pos$Condition, levels = c("WT", "Het"))
```

Now appending the means of each of the cohorts that were verified in Excel by myself, Tian, and Logan for plotting on the figures later
```{r}
#This only needs to be run once
# write.csv(mecp2_data_processed_6wk_simp_neg, "~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Data/mecp2_data_processed_6wk_pre_cohort_mean_non_pv.csv")
# write.csv(mecp2_data_processed_12wk_simp_neg, "~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Data/mecp2_data_processed_12wk_pre_cohort_mean_non_pv.csv")
# write.csv(mecp2_data_processed_6wk_simp_pos, "~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Data/mecp2_data_processed_6wk_pre_cohort_mean_pv.csv")
# write.csv(mecp2_data_processed_12wk_simp_pos, "~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Data/mecp2_data_processed_12wk_pre_cohort_mean_pv.csv")
```

Now reading those files back in and will plot them later
```{r, eval=FALSE}
mecp2_data_processed_6wk_simp_neg <- read.csv("~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Data/mecp2_data_processed_6wk_pre_cohort_mean_non_pv.csv")
mecp2_data_processed_6wk_simp_pos <- read.csv("~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Data/mecp2_data_processed_6wk_pre_cohort_mean_pv.csv")

mecp2_data_processed_12wk_simp_neg <- read.csv("~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Data/mecp2_data_processed_12wk_pre_cohort_mean_non_pv.csv")
mecp2_data_processed_12wk_simp_pos <- read.csv("~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Data/mecp2_data_processed_12wk_pre_cohort_mean_pv.csv")

head(mecp2_data_processed_6wk_simp_neg)
head(mecp2_data_processed_6wk_simp_pos)
head(mecp2_data_processed_12wk_simp_neg)
head(mecp2_data_processed_12wk_simp_pos)

```


Now doing all the statistical analysis and plotting for the PV Nuclei (`PNN-pos`) containing samples
```{r statistical-analysis-for-pv-nuclei, echo=FALSE}
#mecp2_6_12_pos <- bind_rows(mecp2_data_processed_6wk_simp_pos, mecp2_data_processed_12wk_simp_pos)

#Not needed to be run every time since we have already saved the file
# saveRDS(mecp2_6_12_pos,
#         file = "~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Data/mecp2_6_12_pos.rds")

#Performing all KW tests for the overall model and then uncorrected Dunn's tests
#for each of the particular pairwise comparisons in line with collaborator's
#previous analysis

overall_test <- mecp2_6_12_pos %>% kruskal_test(formula = Mean~Time)

example_of_pwc <- mecp2_6_12_pos %>% group_by(Time) %>% filter(Time=="6 wk") %>%
  dunn_test(formula = Mean~Condition, detailed = TRUE, p.adjust.method = "none")

six_wk_comp <- mecp2_6_12_pos %>% group_by(Time) %>% filter(Time=="6 wk") %>%
  dunn_test(formula = Mean~Condition, detailed = TRUE, p.adjust.method = "none")

twelve_wk_comp <- mecp2_6_12_pos %>% group_by(Time) %>% filter(Time=="12 wk") %>%
  dunn_test(formula = Mean~Condition, detailed = TRUE, p.adjust.method = "none")

#6 week WT v. 6 week Het
wt_v_wt_comp <- mecp2_6_12_pos %>% group_by(Condition) %>% filter(Condition=="WT") %>%
  dunn_test(formula = Mean~Time, detailed = TRUE, p.adjust.method = "none")

#6 week Het v. 12 week Het
het_v_het_comp <- mecp2_6_12_pos %>% group_by(Condition) %>% filter(Condition=="Het") %>%
  dunn_test(formula = Mean~Time, detailed = TRUE, p.adjust.method = "none")


#Effect size and effects size interpretation
overall_effect_size <- kruskal_effsize(data = mecp2_6_12_pos, 
                                       formula = Mean~Time, ci = TRUE)

six_wk_eff_size_df <- mecp2_6_12_pos %>% group_by(Time) %>% filter(Time=="6 wk")
six_wk_eff_size <- hedges_g(data = six_wk_eff_size_df, x = Mean~Condition)



twelve_wk_eff_size_df <- mecp2_6_12_pos %>% group_by(Time) %>% filter(Time=="12 wk")
twelve_wk_eff_size <- hedges_g(data = twelve_wk_eff_size_df, x = Mean~Condition)



wt_v_wt_eff_size_df <- mecp2_6_12_pos %>% group_by(Condition) %>% filter(Condition=="WT")
wt_v_wt_eff_size <- hedges_g(data = wt_v_wt_eff_size_df, x = Mean~Time)


het_v_het_eff_size_df <- mecp2_6_12_pos %>% group_by(Condition) %>% filter(Condition=="Het")
het_v_het_eff_size <- hedges_g(data = het_v_het_eff_size_df, x = Mean~Time)

overall_test_label <- create_test_label(description = "Kruskal-Wallis",
                                        statistic.text = quote(italic(chi)^2),
                                        statistic = 0.151, p = "0.697",
                                        parameter = "1", n = 188,
                                        effect.size.text = quote(italic(eta)^2),
                                        effect.size = -0.00456, detailed = TRUE,
                                        type = "expression")


#Now back to doing plotting stuff
mecp2_6_12_pos$Time <- factor(mecp2_6_12_pos$Time, levels = c("6 wk", "12 wk"))

mecp2_6_12_pos$Combo <- paste0(mecp2_6_12_pos$Condition,"_", mecp2_6_12_pos$Time)
mecp2_6_12_pos$Combo <- factor(mecp2_6_12_pos$Combo, levels = c("WT_6 wk",
                                                                "Het_6 wk", 
                                                                "WT_12 wk",
                                                                "Het_12 wk"))


#Plot
total_plot <- ggplot(aes(x=Combo,y=Mean, fill=Cohort), data = mecp2_6_12_pos)+
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), fill="white", colour="black")+
  theme(panel.background = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        axis.title = element_text(face = "bold"),
        axis.text = element_text(face = "bold"),
        legend.position = "right")+
  ylab("Mean MECP2 Intensity (a.u.)")+
  xlab("")+
  ggtitle("PV Nuclei")+
  geom_signif(y_position = c(4300, 4000), xmin = c(1.0,3.0), xmax = c(2.0,4.0),
              annotations = c("ns", "ns"), tip_length = 0)+
  geom_signif(y_position = 4500, xmin = 1.0, xmax = 3.0, annotations = "ns",
              tip_length = 0)+
  geom_signif(y_position = 4200, xmin = 2.0, xmax = 4.0, annotations = "ns",
              tip_length = 0)+
  labs(
    subtitle = overall_test_label,
    caption = get_pwc_label(example_of_pwc)
    )


total_plot <- total_plot + scale_x_discrete(breaks = c("WT_6 wk","Het_6 wk",
                                                       "WT_12 wk", "Het_12 wk"),
                                            labels = c("WT \n(n = 46)", 
                                                       "Het \n(n = 33)", 
                                                       "WT \n(n = 59)", 
                                                       "Het \n(n = 46)"))

#Subsetting to each individual cohort to calculate each of the 6 means to plot
mecp2_6_12_pos_coh1_6wk <- filter(mecp2_6_12_pos, Cohort=="#102319" | Time=="6wk")
mecp2_6_12_pos_coh1_12wk <- filter(mecp2_6_12_pos, Cohort=="#013118" | Time=="12wk")

mecp2_6_12_pos_coh2_6wk <- filter(mecp2_6_12_pos, Cohort=="#103119" | Time=="6wk")
mecp2_6_12_pos_coh2_12wk <- filter(mecp2_6_12_pos, Cohort=="#022518" | Time=="12wk")

mecp2_6_12_pos_coh3_6wk <- filter(mecp2_6_12_pos, Cohort=="#121119B" | Time=="6wk")
mecp2_6_12_pos_coh3_12wk <- filter(mecp2_6_12_pos, Cohort=="#021818" | Time=="12wk")



total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#102319"), data = mecp2_6_12_pos_coh1_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#103119"), data = mecp2_6_12_pos_coh2_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#121119B"), data = mecp2_6_12_pos_coh3_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#013118"), data = mecp2_6_12_pos_coh1_12wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#022518"), data = mecp2_6_12_pos_coh2_12wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#021818"), data = mecp2_6_12_pos_coh3_12wk)

total_plot <- total_plot + scale_fill_manual(values = c("#013118"="orange", 
                                                        "#021818"="brown",
                                                        "#022518"="blue", 
                                                        "#102319"="purple",
                                                        "#103119"="green", 
                                                        "#121119B"="magenta"))


total_plot_pos <- total_plot
```


```{r displaying-pos-plot}
total_plot_pos
```



Now doing all the statistical analysis and plotting for the Non-PV Nuclei (`PNN-neg`) containing samples
```{r statistical-analysis-for-non-pv-nuclei, echo=FALSE}
# mecp2_6_12_neg <- bind_rows(mecp2_data_processed_6wk_simp_neg,
#                             mecp2_data_processed_12wk_simp_neg)

#Only need to run this once because we are saving the data frame
# saveRDS(mecp2_6_12_neg,
#         file = "~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Data/mecp2_6_12_neg.rds")
# 

#Performing all the same statistical tests and comparisons for the 12 week data
#that we did on the six week data
overall_test <- mecp2_6_12_neg %>% kruskal_test(formula = Mean~Time)

example_of_pwc <- mecp2_6_12_neg %>% group_by(Time) %>% filter(Time=="6 wk") %>% 
  dunn_test(formula = Mean~Condition, detailed = TRUE, p.adjust.method = "none")

six_wk_comp <- mecp2_6_12_neg %>% group_by(Time) %>% filter(Time=="6 wk") %>%
  dunn_test(formula = Mean~Condition, detailed = TRUE, p.adjust.method = "none")

twelve_week_comp <- mecp2_6_12_neg %>% group_by(Time) %>% filter(Time=="12 wk") %>%
  dunn_test(formula = Mean~Condition, detailed = TRUE, p.adjust.method = "none")

wt_v_wt_comp <- mecp2_6_12_neg %>% group_by(Condition) %>% filter(Condition=="WT") %>%
  dunn_test(formula = Mean~Time, detailed = TRUE, p.adjust.method = "none")

het_v_het_comp <- mecp2_6_12_neg %>% group_by(Condition) %>% filter(Condition=="Het") %>% 
  dunn_test(formula = Mean~Time, detailed = TRUE, p.adjust.method = "none")


#Effect size and effects size interpretation
overall_effect_size <- kruskal_effsize(data = mecp2_6_12_neg,
                                       formula = Mean~Time, ci = TRUE)

six_wk_eff_size_df <- mecp2_6_12_neg %>% group_by(Time) %>% filter(Time=="6 wk")
six_wk_eff_size <- hedges_g(data = six_wk_eff_size_df, x = Mean~Condition)



twelve_wk_eff_size_df <- mecp2_6_12_neg %>% group_by(Time) %>% filter(Time=="12 wk")
twelve_wk_eff_size <- hedges_g(data = twelve_wk_eff_size_df, x = Mean~Condition)



wt_v_wt_eff_size_df <- mecp2_6_12_neg %>% group_by(Condition) %>% filter(Condition=="WT")
wt_v_wt_eff_size <- hedges_g(data = wt_v_wt_eff_size_df, x = Mean~Time)


het_v_het_eff_size_df <- mecp2_6_12_neg %>% group_by(Condition) %>% filter(Condition=="Het")
het_v_het_eff_size <- hedges_g(data = het_v_het_eff_size_df, x = Mean~Time)

overall_test_label <- create_test_label(description = "Kruskal-Wallis",
                                        statistic.text = quote(italic(chi)^2),
                                        statistic = 24.2, p = "<0.0001",
                                        parameter = "1", n = 223,
                                        effect.size.text = quote(italic(eta)^2),
                                        effect.size = 0.1,
                                        detailed = TRUE, type = "expression")



#Now back to plotting stuff
mecp2_6_12_neg$Time <- factor(mecp2_6_12_neg$Time, levels = c("6 wk", "12 wk"))

mecp2_6_12_neg$Combo <- paste0(mecp2_6_12_neg$Condition,"_", mecp2_6_12_neg$Time)
mecp2_6_12_neg$Combo <- factor(mecp2_6_12_neg$Combo, levels = c("WT_6 wk", 
                                                                "Het_6 wk", 
                                                                "WT_12 wk",
                                                                "Het_12 wk"))


#Plot
total_plot <- ggplot(aes(x=Combo,y=Mean, fill=Cohort), data = mecp2_6_12_neg)+
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), fill="white", colour="black")+
  theme(panel.background = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        axis.title = element_text(face = "bold"),
        axis.text = element_text(face = "bold"),
        legend.position = "right")+
  ylab("Mean MECP2 Intensity (a.u.)")+
  xlab("")+
  ggtitle("Non-PV Nuclei")+
  geom_signif(y_position = c(1800, 1800), xmin = c(1.0,3.0), xmax = c(2.0,4.0),
              annotations = c("*", "ns"), tip_length = 0)+
  geom_signif(y_position = 2200, xmin = 1.0, xmax = 3.0, annotations = "*",
              tip_length = 0)+
  geom_signif(y_position = 2500, xmin = 2.0, xmax = 4.0, annotations = "****",
              tip_length = 0)+
  labs(
    subtitle = overall_test_label,
    caption = get_pwc_label(example_of_pwc)
    )


total_plot <- total_plot + scale_x_discrete(breaks = c("WT_6 wk","Het_6 wk",
                                                       "WT_12 wk", "Het_12 wk"),
                                            labels = c("WT \n(n = 47)", 
                                                       "Het \n(n = 58)", 
                                                       "WT \n(n = 58)",
                                                       "Het \n(n = 60)"))

#Subsetting to each individual cohort to calculate each of the 6 means to plot
mecp2_6_12_neg_coh1_6wk <- filter(mecp2_6_12_neg, Cohort=="#102319" | Time=="6wk")
mecp2_6_12_neg_coh1_12wk <- filter(mecp2_6_12_neg, Cohort=="#013118" | Time=="12wk")

mecp2_6_12_neg_coh2_6wk <- filter(mecp2_6_12_neg, Cohort=="#103119" | Time=="6wk")
mecp2_6_12_neg_coh2_12wk <- filter(mecp2_6_12_neg, Cohort=="#022518" | Time=="12wk")

mecp2_6_12_neg_coh3_6wk <- filter(mecp2_6_12_neg, Cohort=="#121119B" | Time=="6wk")
mecp2_6_12_neg_coh3_12wk <- filter(mecp2_6_12_neg, Cohort=="#021818" | Time=="12wk")


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#102319"), data = mecp2_6_12_neg_coh1_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#103119"), data = mecp2_6_12_neg_coh2_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#121119B"), data = mecp2_6_12_neg_coh3_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#013118"), data = mecp2_6_12_neg_coh1_12wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#022518"), data = mecp2_6_12_neg_coh2_12wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#021818"), data = mecp2_6_12_neg_coh3_12wk)

total_plot <- total_plot + scale_fill_manual(values = c("#013118"="orange", 
                                                        "#021818"="brown", 
                                                        "#022518"="blue",
                                                        "#102319"="purple",
                                                        "#103119"="green",
                                                        "#121119B"="magenta"))

total_plot_neg <- total_plot

```


```{r neg-plot}
total_plot_neg
```


```{r combo-plot, echo=FALSE}
#Combining the plots
combo_plot <- ggarrange(total_plot_neg, total_plot_pos, nrow = 1, ncol = 2,
                        labels = c("e", "f"))
combo_plot
```


```{r saving-combo-plot, echo=FALSE, eval=FALSE}
#Saving the plots
ggsave(filename = "~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Figures/mecp2_non_and_pv_together.png", device = "png",
       units = "cm", dpi = 300, width = 32, height = 32, plot = combo_plot)
```

```{r saving-non-pv-plot, echo=FALSE, eval=FALSE}
ggsave(filename = "~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Figures/mecp2_non_pv.png", device = "png",
       units = "cm", dpi = 300, width = 32, height = 32, plot = total_plot_neg)
```

```{r saving-pv-plot, echo=FALSE, eval=FALSE}
ggsave(filename = "~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Figures/mecp2_pv.png", device = "png",
       units = "cm", dpi = 300, width = 32, height = 32, plot = total_plot_pos)
```


Now performing ICC analysis on the combinations we have previously tested to see if any of the variables have high levels of dependence
```{r icc-6-12-week-neg, echo=FALSE}
mecp2_6_12_neg$Cohort <- gsub(x = mecp2_6_12_neg$Cohort,
                                    pattern = "#", 
                                    replacement = "")

#For Cohort
icc_cohort <- ICCbare(x=factor(Cohort), y= Mean, data = mecp2_6_12_neg)

#For Cell number
icc_cell_num <- ICCbare(x=factor(Cell_number), y= Mean, data = mecp2_6_12_neg)

#For Image
icc_img <- ICCbare(x=factor(Image), y= Mean, data = mecp2_6_12_neg)


#Making a data frame
icc_df <- data.frame(Cohort=icc_cohort,
                     Cell_num=icc_cell_num, Image=icc_img)

colnames(icc_df) <- c("Cohort", "Cell number", "Image")
```


```{r gt-table-for-non-pv-mean6-mean12, echo=FALSE}
#Making that data frame a nicer looking table
gt_icc <- gt(icc_df)
gt_icc_done <- gt_icc %>% tab_header(
  title = "ICC for Non-PV MECP2 Data",
  subtitle = "Intraclass Correlation Coefficient (ICC) for Mean 6 and 12 week Non-PV MECP2 data."
 ) %>% cols_align(
  align = "center",
  columns = c("Cohort", "Cell number", "Image")
 ) %>% opt_align_table_header(align = "center")
```


```{r gt-table-for-non-pv-mean6-mean12-displayed, echo=FALSE}
gt_icc_done
```


```{r icc-6-12-week-pos, echo=FALSE}
mecp2_6_12_pos$Cohort <- gsub(x = mecp2_6_12_pos$Cohort,
                                    pattern = "#", 
                                    replacement = "")

#For Cohort
icc_cohort <- ICCbare(x=factor(Cohort), y= Mean, data = mecp2_6_12_pos)

#For Cell number
icc_cell_num <- ICCbare(x=factor(Cell_number), y= Mean, data = mecp2_6_12_pos)

#For Image
icc_img <- ICCbare(x=factor(Image), y= Mean, data = mecp2_6_12_pos)



#Making a data frame
icc_df <- data.frame(Cohort=icc_cohort,
                     Cell_num=icc_cell_num, Image=icc_img)

colnames(icc_df) <- c("Cohort", "Cell number", "Image")
```


```{r gt-table-for-pv-mean6-mean12, echo=FALSE}
#Making that data frame a nicer looking table
gt_icc <- gt(icc_df)
gt_icc_done <- gt_icc %>% tab_header(
  title = "ICC for PV MECP2 Data",
  subtitle = "Intraclass Correlation Coefficient (ICC) for Mean 6 and 12 week PV MECP2 data."
 ) %>% cols_align(
  align = "center",
  columns = c("Cohort", "Cell number", "Image")
 ) %>% opt_align_table_header(align = "center")
```


```{r gt-table-for-pv-mean6-mean12-displayed, echo=FALSE}
gt_icc_done
```


Building the lme for non-PV nuclei because of high ICC for `Cohort`
```{r overall-lme-model-non-pv, echo=FALSE}
#Now building an LME for non-PV because of high ICC of Cohort.
#This is the overall model
lme_mod <- lme(Mean~Time, data=mecp2_6_12_neg , random = ~ 1|Cohort,
               method = "ML")
modelsummary(lme_mod, gof_omit = 'DF|Deviance|R2|AIC|BIC|RMSE|aicc', stars = TRUE,
             statistic = "p = {p.value}",
             coef_omit = "Intercept",
             title = "Overall Non-PV Nuclei LME Model")
```

Doing 6 week WT vs. Het lme model
```{r 6-week-wt-v-het-comp-lme, echo=FALSE}
six_wk_comp_df <- mecp2_6_12_neg %>% group_by(Time) %>% filter(Time=="6 wk")

#Now building an LME for non-PV because of high ICC of Cohort.
#This is the 6 wk WT vs. Het model
lme_mod_6wk_comp <- lme(Mean~Condition, data=six_wk_comp_df, 
                        random = ~ 1|Cohort, method = "ML")

modelsummary(lme_mod_6wk_comp, gof_omit = 'DF|Deviance|R2|AIC|BIC|aicc|RMSE', stars = TRUE,
             statistic = "p = {p.value}",
             coef_omit = "Intercept",
             title = "Non-PV Nuclei 6 week WT v. 6 week Het LME Model")
```

Doing 12 week WT vs. Het lme model
```{r 12-week-wt-v-het-comp-lme, echo=FALSE}
twelve_week_comp <- mecp2_6_12_neg %>% group_by(Time) %>% filter(Time=="12 wk")

#Now building an LME for non-PV because of high ICC of Cohort.
#This is the 12 wk WT vs. Het model
lme_mod_12wk_comp <- lme(Mean~Condition, data=twelve_week_comp,
                         random = ~ 1|Cohort, method = "ML")

modelsummary(lme_mod_12wk_comp, gof_omit = 'DF|Deviance|R2|AIC|BIC|aicc|RMSE', stars = TRUE,
             statistic = "p = {p.value}",
             coef_omit = "Intercept",
             title = "Non-PV Nuclei 12 week WT v. 12 week Het LME Model")
```

Doing 6 week WT vs. 12 week WT lme model
```{r 6-12-week-wt-v-wt-comp-lme, echo=FALSE}
wt_v_wt_comp <- mecp2_6_12_neg %>% group_by(Condition) %>% 
  filter(Condition=="WT")

#Now building an LME for non-PV because of high ICC of Cohort. This is the 6 wk
#vs. 12 wk WT vs. WT model
lme_mod_wt_v_wt_comp <- lme(Mean~Time, data=wt_v_wt_comp, random = ~ 1|Cohort,
                            method = "ML")

modelsummary(lme_mod_wt_v_wt_comp, gof_omit = 'DF|Deviance|R2|AIC|BIC|aicc|RMSE', stars = TRUE,
             statistic = "p = {p.value}",
             coef_omit = "Intercept",
             title = "Non-PV Nuclei 6 week v. 12 week WT LME Model")
```


Doing 6 week Het vs. 12 week Het lme model
```{r 6-12-week-het-v-het-comp-lme, echo=FALSE}
het_v_het_comp <- mecp2_6_12_neg %>% group_by(Condition) %>% 
  filter(Condition=="Het")

#Now building an LME for non-PV because of high ICC of Cohort. This is the 6 
#week v. 12 wk Het vs. Het model
lme_mod_het_v_het_comp <- lme(Mean~Time, data=het_v_het_comp, random = ~ 1|Cohort, 
                              method = "ML")

modelsummary(lme_mod_het_v_het_comp, gof_omit = 'DF|Deviance|R2|AIC|BIC|aicc|RMSE', stars = TRUE,
             statistic = "p = {p.value}",
             coef_omit = "Intercept",
             title = "Non-PV Nuclei 6 week v. 12 week Het LME Model")
```


```{r non-pv-lme-plot, echo=FALSE}
#Non-PV Nuclei plot
overall_test_label <- create_test_label(description = "F-test",
                                        statistic.text = quote(italic(F)),
                                        statistic = -1.33, p = "0.2170",
                                        parameter = "4", n = 223,
                                        detailed = TRUE, type = "expression")

example_of_pwc <- mecp2_6_12_neg %>% group_by(Time) %>% filter(Time=="6 wk") %>%
  t_test(formula = Mean~Condition, detailed = TRUE, p.adjust.method = "none")

#Now back to plotting stuff
mecp2_6_12_neg$Time <- factor(mecp2_6_12_neg$Time, levels = c("6 wk", "12 wk"))

mecp2_6_12_neg$Combo <- paste0(mecp2_6_12_neg$Condition,"_", mecp2_6_12_neg$Time)
mecp2_6_12_neg$Combo <- factor(mecp2_6_12_neg$Combo, levels = c("WT_6 wk", 
                                                                "Het_6 wk",
                                                                "WT_12 wk",
                                                                "Het_12 wk"))

#Plot
total_plot <- ggplot(aes(x=Combo, y=Mean, fill=Cohort),
                     data = mecp2_6_12_neg)+
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), fill="white", colour="black") +
  theme(panel.background = element_blank(),
        plot.title = element_text(hjust = 0.5,
                                  face = "bold"),
        axis.title = element_text(face = "bold"), 
        axis.text = element_text(face = "bold"), 
        legend.position = "right")+
  ylab("Mean MECP2 Intensity (a.u.)")+
  xlab("")+ggtitle("Non-PV Nuclei")+
  geom_signif(y_position = c(1750, 1500), xmin = c(1.0,3.0), xmax = c(2.0,4.0),
              annotations = c("**", "ns"), tip_length = 0)+
  geom_signif(y_position = 2000, xmin = 1.0, xmax = 3.0, annotations = "ns",
              tip_length = 0)+
  geom_signif(y_position = 2300, xmin = 2.0, xmax = 4.0, annotations = "ns",
              tip_length = 0)+
  labs(subtitle = overall_test_label,
       caption = get_pwc_label(example_of_pwc))

  

total_plot <- total_plot + scale_x_discrete(breaks = c("WT_6 wk","Het_6 wk", 
                                                       "WT_12 wk", "Het_12 wk"),
                                            labels = c("WT \n(n = 47)",
                                                       "Het \n(n = 58)",
                                                       "WT \n(n = 58)",
                                                       "Het \n(n = 60)"))

#Subsetting to each individual cohort to calculate each of the 6 means to plot
mecp2_6_12_neg_coh1_6wk <- filter(mecp2_6_12_neg, Cohort=="#102319" | Time=="6wk")
mecp2_6_12_neg_coh1_12wk <- filter(mecp2_6_12_neg, Cohort=="#013118" | Time=="12wk")

mecp2_6_12_neg_coh2_6wk <- filter(mecp2_6_12_neg, Cohort=="#103119" | Time=="6wk")
mecp2_6_12_neg_coh2_12wk <- filter(mecp2_6_12_neg, Cohort=="#022518" | Time=="12wk")

mecp2_6_12_neg_coh3_6wk <- filter(mecp2_6_12_neg, Cohort=="#121119B" | Time=="6wk")
mecp2_6_12_neg_coh3_12wk <- filter(mecp2_6_12_neg, Cohort=="#021818" | Time=="12wk")
```


```{r non-pv-lme-plot-stat, echo=FALSE}
total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#102319"), data = mecp2_6_12_neg_coh1_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#103119"), data = mecp2_6_12_neg_coh2_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#121119B"), data = mecp2_6_12_neg_coh3_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#013118"), data = mecp2_6_12_neg_coh1_12wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#022518"), data = mecp2_6_12_neg_coh2_12wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#021818"), data = mecp2_6_12_neg_coh3_12wk)



total_plot <- total_plot + scale_fill_manual(values = c("#013118"="orange", 
                                                        "#021818"="brown", 
                                                        "#022518"="blue", 
                                                        "#102319"="purple", 
                                                        "#103119"="green", 
                                                        "#121119B"="magenta"))


total_plot_lme <- total_plot
```


```{r non-pv-lme-plot-displayed, echo=FALSE, eval=FALSE}
total_plot_lme
```


```{r saving-lme-plot, echo=FALSE, eval=FALSE}
#Saving lme plot
ggsave(filename = "~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Figures/lme_non_pv_plot.png",
       device = "png", dpi = 300, units = "cm", height = 32,
       width = 32, plot = total_plot_lme)
```


Getting an lme of PV nuclei even though their ICC is low (0.12) and plotting to see if anything changes
```{r lme-mod-for-pv-nuclei, echo=FALSE}
#This is the overall model
lme_mod <- lme(Mean~Time, data=mecp2_6_12_pos, random = ~ 1|Cohort,
               method = "ML")

# modelsummary(lme_mod, gof_omit = 'DF|Deviance|R2|AIC|BIC|aicc|RMSE',
#              stars = TRUE,
#              statistic = "p = {p.value}",
#              coef_omit = "Intercept",
#              title = "PV Nuclei LME Model")

summary(lme_mod)
```

Doing 6 week WT vs. Het lme model
```{r lme-mod-for-6-week-wt-v-het-pv-nuclei, echo=FALSE}
six_wk_comp_df <- mecp2_6_12_pos %>% group_by(Time) %>% filter(Time=="6 wk")

#This is the 6 wk WT vs. Het model
lme_mod_6wk_comp <- lme(Mean~Condition, data=six_wk_comp_df, 
                        random = ~ 1|Cohort, method = "ML")

# modelsummary(lme_mod_6wk_comp, gof_omit = 'DF|Deviance|R2|AIC|BIC|aicc|RMSE',
#              stars = TRUE,
#              statistic = "p = {p.value}",
#              coef_omit = "Intercept",
#              title = "PV Nuclei 6 week WT v. 6 week Het LME Model")

summary(lme_mod_6wk_comp)
```

Doing 12 week WT vs. Het lme model
```{r lme-mod-for-12-week-wt-v-het-pv-nuclei, echo=FALSE}
twelve_week_comp <- mecp2_6_12_pos %>% group_by(Time) %>% filter(Time=="12 wk")

#This is the 12 wk WT vs. Het model
lme_mod_12wk_comp <- lme(Mean~Condition, data=twelve_week_comp,
                         random = ~ 1|Cohort, method = "ML")

# modelsummary(lme_mod_12wk_comp, gof_omit = 'DF|Deviance|R2|AIC|BIC|aicc|RMSE',
#              stars = TRUE,
#              statistic = "p = {p.value}",
#              coef_omit = "Intercept",
#              title = "PV Nuclei 12 week WT v. 12 week Het LME Model")

summary(lme_mod_12wk_comp)
```

Doing 6 week WT vs. 12 week WT lme model
```{r lme-mod-for-6-week-wt-v-wt-pv-nuclei, echo=FALSE}
wt_v_wt_comp <- mecp2_6_12_pos %>% group_by(Condition) %>% 
  filter(Condition=="WT")

#This is the 6 wk vs. 12 wk WT vs. WT model
lme_mod_wt_v_wt_comp <- lme(Mean~Time, data=wt_v_wt_comp, random = ~ 1|Cohort,
                            method = "ML")

# modelsummary(lme_mod_wt_v_wt_comp, gof_omit = 'DF|Deviance|R2|AIC|BIC|aicc|RMSE',
#              stars = TRUE,
#              statistic = "p = {p.value}",
#              coef_omit = "Intercept",
#              title = "PV Nuclei 6 week WT v. 12 week WT LME Model")

summary(lme_mod_wt_v_wt_comp)
```


Doing 6 week Het vs. 12 week Het lme model
```{r lme-mod-for-12-week-het-v-het-pv-nuclei, echo=FALSE}
het_v_het_comp <- mecp2_6_12_pos %>% group_by(Condition) %>% 
  filter(Condition=="Het")

#This is the 12 wk Het vs. Het model
lme_mod_het_v_het_comp <- lme(Mean~Time, data=het_v_het_comp,
                              random = ~ 1|Cohort, 
                              method = "ML")

# modelsummary(lme_mod_het_v_het_comp, gof_omit = 'DF|Deviance|R2|AIC|BIC|aicc|RMSE',
#              stars = TRUE,
#              statistic = "p = {p.value}",
#              coef_omit = "Intercept",
#              title = "PV Nuclei 6 week Het v. 12 week Het LME Model")

summary(lme_mod_het_v_het_comp)
```

PV Nuclei lme plot
```{r overall-lme-model-pv-nuclei, echo=FALSE}
overall_test_label <- create_test_label(description = "F-test",
                                        statistic.text = quote(italic(F)),
                                        statistic = -0.288711, p = "0.7871",
                                        parameter = "4", n = 222,
                                        detailed = TRUE, type = "expression")

example_of_pwc <- mecp2_6_12_pos %>% group_by(Time) %>% filter(Time=="6 wk") %>%
  t_test(formula = Mean~Condition, detailed = TRUE, p.adjust.method = "none")

#Now back to plotting stuff
mecp2_6_12_pos$Time <- factor(mecp2_6_12_pos$Time, levels = c("6 wk", "12 wk"))

mecp2_6_12_pos$Combo <- paste0(mecp2_6_12_pos$Condition,"_", mecp2_6_12_pos$Time)
mecp2_6_12_pos$Combo <- factor(mecp2_6_12_pos$Combo, levels = c("WT_6 wk", 
                                                                "Het_6 wk",
                                                                "WT_12 wk",
                                                                "Het_12 wk"))

#Plot
total_plot <- ggplot(aes(x=Combo, y=Mean, fill=Cohort),
                     data = mecp2_6_12_pos)+
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), fill="white", colour="black") +
  theme(panel.background = element_blank(),
        plot.title = element_text(hjust = 0.5,
                                  face = "bold"),
        axis.title = element_text(face = "bold"), 
        axis.text = element_text(face = "bold"), 
        legend.position = "right")+
  ylab("Mean MECP2 Intensity (a.u.)")+
  xlab("")+ggtitle("PV Nuclei")+
  geom_signif(y_position = c(4300, 4000), xmin = c(1.0,3.0), xmax = c(2.0,4.0),
              annotations = c("*", "ns"), tip_length = 0)+
  geom_signif(y_position = 4600, xmin = 1.0, xmax = 3.0, annotations = "ns",
              tip_length = 0)+
  geom_signif(y_position = 4200, xmin = 2.0, xmax = 4.0, annotations = "ns",
              tip_length = 0)+
  labs(subtitle = overall_test_label,
       caption = get_pwc_label(example_of_pwc))

  

total_plot <- total_plot + scale_x_discrete(breaks = c("WT_6 wk","Het_6 wk", 
                                                       "WT_12 wk", "Het_12 wk"),
                                            labels = c("WT \n(n = 46)",
                                                       "Het \n(n = 33)",
                                                       "WT \n(n = 59)",
                                                       "Het \n(n = 46)"))

#Subsetting to each individual cohort to calculate each of the 6 means to plot
mecp2_6_12_pos_coh1_6wk <- filter(mecp2_6_12_pos, Cohort=="#102319" | Time=="6wk")
mecp2_6_12_pos_coh1_12wk <- filter(mecp2_6_12_pos, Cohort=="#013118" | Time=="12wk")

mecp2_6_12_pos_coh2_6wk <- filter(mecp2_6_12_pos, Cohort=="#103119" | Time=="6wk")
mecp2_6_12_pos_coh2_12wk <- filter(mecp2_6_12_pos, Cohort=="#022518" | Time=="12wk")

mecp2_6_12_pos_coh3_6wk <- filter(mecp2_6_12_pos, Cohort=="#121119B" | Time=="6wk")
mecp2_6_12_pos_coh3_12wk <- filter(mecp2_6_12_pos, Cohort=="#021818" | Time=="12wk")
```


```{r overall-lme-model-pv-nuclei-stats, echo=FALSE}
total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#102319"), data = mecp2_6_12_pos_coh1_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#103119"), data = mecp2_6_12_pos_coh2_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#121119B"), data = mecp2_6_12_pos_coh3_6wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#013118"), data = mecp2_6_12_pos_coh1_12wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#022518"), data = mecp2_6_12_pos_coh2_12wk)


total_plot <- total_plot + stat_summary(fun=mean, geom="point", shape=21,
                                        size=5, aes(fill="#021818"), data = mecp2_6_12_pos_coh3_12wk)

total_plot <- total_plot + scale_fill_manual(values = c("#013118"="orange", 
                                                        "#021818"="brown",
                                                        "#022518"="blue", 
                                                        "#102319"="purple", 
                                                        "#103119"="green",
                                                        "#121119B"="magenta"))


total_plot_lme_pv <- total_plot
```



```{r overall-lme-model-pv-nuclei-plot, echo=FALSE, eval=FALSE}
total_plot_lme_pv
```


```{r saving-lme-plot-pv, echo=FALSE, eval=FALSE}
#Saving lme plot
ggsave(filename = "~/Documents/Work/PhD Program/Hong Lab/Projects/Krishnan-Analysis/Figures/lme_pv_plot.png",
       device = "png", dpi = 300, units = "cm", height = 32,
       width = 32, plot = total_plot_lme_pv)
```


Now doing ICC for just the non-pv het samples between 6 and 12 weeks to see if the ICC is large for this specific comparison or not
```{r het-only-icc, echo=FALSE}
mecp2_6_12_neg_het <- filter(mecp2_6_12_neg, Condition=="Het")

#For Cohort
icc_cohort <- ICCbare(x=factor(Cohort), y= Mean, data = mecp2_6_12_neg_het)

#For Cell number
icc_cell_num <- ICCbare(x=factor(Cell_number), y= Mean, data = mecp2_6_12_neg_het)

#For Image
icc_img <- ICCbare(x=factor(Image), y= Mean, data = mecp2_6_12_neg_het)



#Making a data frame
icc_df <- data.frame(Cohort=icc_cohort,
                     Cell_num=icc_cell_num, Image=icc_img)

colnames(icc_df) <- c("Cohort", "Cell number", "Image")
```

```{r het-only-gt-table-made, echo=FALSE}
#Making that data frame a nicer looking table
gt_icc <- gt(icc_df)
gt_icc_done <- gt_icc %>% tab_header(
  title = "ICC for Non-PV Het Only MECP2 Data",
  subtitle = "Intraclass Correlation Coefficient (ICC) for Mean 6 and 12 week Non-PV Het Only MECP2 data."
 ) %>% cols_align(
  align = "center",
  columns = c("Cohort", "Cell number", "Image")
 ) %>% opt_align_table_header(align = "center")
```


```{r het-only-gt-table-displayed, echo=FALSE}
gt_icc_done
```


Given the change from very statistically significant to non-significance between the 6 week and 12 week `Het` groups I wanted to see how many correlated neurons equaled one uncorrelated neuron and how many more neurons we would need to see a difference between these groups. I took the total number of neurons from the MECP2 negative group and divided it by the number of cohorts (because `cohort` is the variable with a high ICC). From this I got the average cluster size `M`. From there I calculated the Design Effect (`deff`). This tells us how many dependent neurons equal one uncorrelated neuron. From this we can get the effective sample size (`neff`) which tells us the equivalent number of cohorts if there was no correlation/clustering.   
```{r, echo=FALSE}
#Took the total number of neurons from mecp2_6_12_neg (het v. het comparison at
#6 and 12 weeks) (number of rows) and divided it by the number of cohorts (6) 
#because that is the variable that has an ICC of ~0.5
M_het <- 222/6

deff <- 1 + 0.4977328*(M_het)

neff <- 222/deff

analysis_df <- data.frame(M=round(M_het, digits = 2), 
                          Design_effect=round(deff, digits = 2), 
                          Effective_size=round(neff, digits = 2))

colnames(analysis_df) <- c("M", "Design effect", "Effective size")
analysis_df_gt <- gt(analysis_df)


analysis_df_gt <- analysis_df_gt %>% tab_header(
  title = "Power Analysis for Non-PV  All Samples",
  subtitle = "Metrics to determine what sample size is needed to determine if their are statistically significant differences that are independent of cohort"
 ) %>% cols_align(
  align = "center",
  columns = c("M", "Design effect", "Effective size")
 ) %>% opt_align_table_header(align = "center")
```
Our results show that about 11.44 cohorts is what we would need to get a sample size that would be equivalent to a sample size that had no correlation/clustering. This is about 1.91 times as many cohorts. (e.g. 12 needed instead of the 6 currently done). Given this we recommend an additional `n` of 6 mouse cohorts for analysis.

```{r}
analysis_df_gt
```



Non-PV Het only recommendation
```{r}
#Took the total number of neurons from mecp2_6_12_neg (het v. het comparison at
#6 and 12 weeks) (number of rows) and divided it by the number of cohorts (6) 
#because that is the variable that has an ICC of ~0.5
mecp2_6_12_neg_het <- filter(mecp2_6_12_neg, Condition=="Het")

M_het <- 118/6

deff <- 1 + 0.5143417*(M_het)

neff <- 118/deff

analysis_df <- data.frame(M=round(M_het, digits = 2), 
                          Design_effect=round(deff, digits = 2), 
                          Effective_size=round(neff, digits = 2))

colnames(analysis_df) <- c("M", "Design effect", "Effective size")
analysis_df_gt <- gt(analysis_df)


analysis_df_gt <- analysis_df_gt %>% tab_header(
  title = "Power Analysis for Non-PV Het Only Samples",
  subtitle = "Metrics to determine what sample size is needed to determine if their are statistically significant differences that are independent of cohort"
 ) %>% cols_align(
  align = "center",
  columns = c("M", "Design effect", "Effective size")
 ) %>% opt_align_table_header(align = "center")
```


```{r}
analysis_df_gt
```


Checking if WT only non-PV has high ICC for Keerthi
```{r wt-only-icc, echo=FALSE}
mecp2_6_12_neg_wt <- filter(mecp2_6_12_neg, Condition=="WT")

#For Cohort
icc_cohort <- ICCbare(x=factor(Cohort), y= Mean, data = mecp2_6_12_neg_wt)

#For Cell number
icc_cell_num <- ICCbare(x=factor(Cell_number), y= Mean, data = mecp2_6_12_neg_wt)

#For Image
icc_img <- ICCbare(x=factor(Image), y= Mean, data = mecp2_6_12_neg_wt)



#Making a data frame
icc_df <- data.frame(Cohort=icc_cohort,
                     Cell_num=icc_cell_num, Image=icc_img)

colnames(icc_df) <- c("Cohort", "Cell number", "Image")
```

```{r wt-only-gt-table-made, echo=FALSE}
#Making that data frame a nicer looking table
gt_icc <- gt(icc_df)
gt_icc_done <- gt_icc %>% tab_header(
  title = "ICC for Non-PV WT Only MECP2 Data",
  subtitle = "Intraclass Correlation Coefficient (ICC) for Mean 6 and 12 week Non-PV WT Only MECP2 data."
 ) %>% cols_align(
  align = "center",
  columns = c("Cohort", "Cell number", "Image")
 ) %>% opt_align_table_header(align = "center")
```


```{r wt-only-gt-table-displayed, echo=FALSE}
gt_icc_done
```

Non-PV WT only recommendation
```{r}
#Took the total number of neurons from mecp2_6_12_neg (het v. het comparison at
#6 and 12 weeks) (number of rows) and divided it by the number of cohorts (6) 
#because that is the variable that has an ICC of ~0.5
mecp2_6_12_neg_wt <- filter(mecp2_6_12_neg, Condition=="WT")

M_het <- 104/6

deff <- 1 + 0.5157874*(M_het)

neff <- 104/deff

analysis_df <- data.frame(M=round(M_het, digits = 2), 
                          Design_effect=round(deff, digits = 2), 
                          Effective_size=round(neff, digits = 2))

colnames(analysis_df) <- c("M", "Design effect", "Effective size")
analysis_df_gt <- gt(analysis_df)


analysis_df_gt <- analysis_df_gt %>% tab_header(
  title = "Power Analysis for Non-PV WT Only Samples",
  subtitle = "Metrics to determine what sample size is needed to determine if their are statistically significant differences that are independent of cohort"
 ) %>% cols_align(
  align = "center",
  columns = c("M", "Design effect", "Effective size")
 ) %>% opt_align_table_header(align = "center")
```

```{r}
analysis_df_gt
```


